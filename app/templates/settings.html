{% extends "base.html" %}

{% block title %}Settings - InfoGarden{% endblock %}

{% block content %}
<h1>Settings</h1>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Branding</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="brand_name" class="form-label">Brand Name</label>
                        <input type="text" class="form-control" id="brand_name" name="brand_name" 
                               value="{{ settings.get('brand_name', 'InfoGarden') }}" 
                               placeholder="InfoGarden">
                        <small class="form-text text-muted">This name will replace "InfoGarden" in the navbar and throughout the application.</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Brand Name</button>
                </form>
                
                <hr>
                
                <form method="POST" action="{{ url_for('core_auth.upload_logo') }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="logo" class="form-label">Brand Logo (JPEG)</label>
                        <input type="file" class="form-control" id="logo" name="logo" accept="image/jpeg,image/jpg">
                        <small class="form-text text-muted">Upload a JPEG image that will appear in the navbar and on the login page.</small>
                    </div>
                    {% if settings.get('brand_logo') %}
                    <div class="mb-3">
                        <label class="form-label">Current Logo:</label>
                        <div>
                            <img src="{{ settings.get('brand_logo') }}" alt="Brand Logo" style="max-height: 60px; max-width: 200px;">
                        </div>
                    </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Upload Logo</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Backup Settings</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="backup_enabled" name="backup_enabled" 
                                   {{ 'checked' if settings.get('backup_enabled', 'true') == 'true' else '' }}>
                            <label class="form-check-label" for="backup_enabled">
                                Enable automatic backups
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="backup_day" class="form-label">Backup Day</label>
                        <select class="form-select" id="backup_day" name="backup_day">
                            <option value="sunday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'sunday' else '' }}>Sunday</option>
                            <option value="monday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'monday' else '' }}>Monday</option>
                            <option value="tuesday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'tuesday' else '' }}>Tuesday</option>
                            <option value="wednesday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'wednesday' else '' }}>Wednesday</option>
                            <option value="thursday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'thursday' else '' }}>Thursday</option>
                            <option value="friday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'friday' else '' }}>Friday</option>
                            <option value="saturday" {{ 'selected' if settings.get('backup_day', 'sunday') == 'saturday' else '' }}>Saturday</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="backup_hour" class="form-label">Hour (0-23)</label>
                                <input type="number" class="form-control" id="backup_hour" name="backup_hour" 
                                       value="{{ settings.get('backup_hour', '0') }}" min="0" max="23">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="backup_minute" class="form-label">Minute (0-59)</label>
                                <input type="number" class="form-control" id="backup_minute" name="backup_minute" 
                                       value="{{ settings.get('backup_minute', '0') }}" min="0" max="59">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="retention_days" class="form-label">Backup Retention (days)</label>
                        <input type="number" class="form-control" id="retention_days" name="retention_days" 
                               value="{{ settings.get('retention_days', '30') }}" min="1">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Backup Management</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('core_auth.backup_create') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-success">Create Manual Backup</button>
                </form>
                <a href="{{ url_for('core_auth.backup_list') }}" class="btn btn-primary mt-2">View Backups</a>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>IP Whitelist</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ip_whitelist_enabled" name="ip_whitelist_enabled" 
                                   {{ 'checked' if settings.get('ip_whitelist_enabled', 'false') == 'true' else '' }}>
                            <label class="form-check-label" for="ip_whitelist_enabled">
                                Enable IP Whitelist
                            </label>
                        </div>
                        <small class="form-text text-muted">When enabled, only IP addresses in the whitelist will be able to access the application.</small>
                    </div>
                    <div class="mb-3">
                        <label for="ip_whitelist" class="form-label">Allowed IP Addresses</label>
                        <textarea class="form-control" id="ip_whitelist" name="ip_whitelist" rows="5" 
                                  placeholder="192.168.1.1&#10;10.0.0.0/8&#10;172.16.0.0/12">{{ settings.get('ip_whitelist', '') }}</textarea>
                        <small class="form-text text-muted">
                            Enter one IP address or CIDR range per line, or comma-separated on a single line.<br>
                            Examples: <code>192.168.1.1</code>, <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code><br>
                            {% if current_client_ip %}
                            <strong>Your current IP:</strong> <code>{{ current_client_ip }}</code><br>
                            {% endif %}
                            <strong>Warning:</strong> If you enable this and your IP is not in the list, you will be locked out! Make sure to add your IP before enabling.
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save IP Whitelist Settings</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>SMTP Settings</h5>
            </div>
            <div class="card-body">
                <form id="smtp-settings-form" method="POST" action="{{ url_for('core_auth.smtp_settings_save') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_server" class="form-label">SMTP Server *</label>
                                <input type="text" class="form-control" id="smtp_server" name="smtp_server" 
                                       value="{{ settings.get('smtp_server', '') }}" 
                                       placeholder="smtp.gmail.com" required>
                                <small class="form-text text-muted">SMTP server hostname</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_port" class="form-label">SMTP Port *</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                                       value="{{ settings.get('smtp_port', '587') }}" 
                                       min="1" max="65535" required>
                                <small class="form-text text-muted">Common ports: 587 (TLS), 465 (SSL), 25</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="smtp_use_tls" name="smtp_use_tls" 
                                   {{ 'checked' if settings.get('smtp_use_tls', 'true') == 'true' else '' }}>
                            <label class="form-check-label" for="smtp_use_tls">
                                Use TLS/STARTTLS
                            </label>
                            <small class="form-text text-muted d-block">Enable for most modern SMTP servers (Gmail, Outlook, etc.)</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_username" class="form-label">SMTP Username</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username" 
                                       value="{{ settings.get('smtp_username', '') }}" 
                                       placeholder="your-email@example.com">
                                <small class="form-text text-muted">Usually your email address</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_password" class="form-label">SMTP Password</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" 
                                       placeholder="Leave blank to keep existing password">
                                <small class="form-text text-muted">App password for Gmail, or your email password</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_from_email" class="form-label">From Email Address *</label>
                                <input type="email" class="form-control" id="smtp_from_email" name="smtp_from_email" 
                                       value="{{ settings.get('smtp_from_email', '') }}" 
                                       placeholder="noreply@example.com" required>
                                <small class="form-text text-muted">Email address that will appear as sender</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtp_from_name" class="form-label">From Name</label>
                                <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" 
                                       value="{{ settings.get('smtp_from_name', '') }}" 
                                       placeholder="InfoGarden">
                                <small class="form-text text-muted">Display name for the sender</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">Save SMTP Settings</button>
                    </div>
                </form>
                
                <hr>
                
                <h6>Test SMTP Configuration</h6>
                <p class="text-muted">Test your SMTP settings by sending a test email. The test will use the current form values.</p>
                <form id="smtp-test-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="test_email" class="form-label">Test Email Address *</label>
                                <input type="email" class="form-control" id="test_email" name="test_email" 
                                       placeholder="test@example.com" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-info w-100" id="test-smtp-btn">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Send Test Email
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Google reCAPTCHA v2 Settings</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="recaptcha_enabled" name="recaptcha_enabled" 
                                   {{ 'checked' if settings.get('recaptcha_enabled', 'false') == 'true' else '' }}>
                            <label class="form-check-label" for="recaptcha_enabled">
                                Enable Google reCAPTCHA v2
                            </label>
                        </div>
                        <small class="form-text text-muted">When enabled, users will need to complete reCAPTCHA verification on the login page.</small>
                    </div>
                    <div class="mb-3">
                        <label for="recaptcha_site_key" class="form-label">reCAPTCHA Site Key</label>
                        <input type="text" class="form-control" id="recaptcha_site_key" name="recaptcha_site_key" 
                               value="{{ settings.get('recaptcha_site_key', '') }}" 
                               placeholder="6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI">
                        <small class="form-text text-muted">Your reCAPTCHA v2 site key from Google. Get your keys from <a href="https://www.google.com/recaptcha/admin" target="_blank">Google reCAPTCHA Admin</a>.</small>
                    </div>
                    <div class="mb-3">
                        <label for="recaptcha_secret_key" class="form-label">reCAPTCHA Secret Key</label>
                        <input type="password" class="form-control" id="recaptcha_secret_key" name="recaptcha_secret_key" 
                               placeholder="Leave blank to keep existing secret key">
                        <small class="form-text text-muted">Your reCAPTCHA v2 secret key from Google. Leave blank to keep the existing key.{% if settings.get('recaptcha_secret_key') %} <span class="text-success">(Currently configured)</span>{% endif %}</small>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> reCAPTCHA will only be active when both keys are provided and the feature is enabled. 
                        Make sure to use reCAPTCHA v2 keys (not v3).
                    </div>
                    <button type="submit" class="btn btn-primary">Save reCAPTCHA Settings</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // SMTP Test Form Handler
    document.getElementById('smtp-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const testBtn = document.getElementById('test-smtp-btn');
        const spinner = testBtn.querySelector('.spinner-border');
        const originalText = testBtn.innerHTML;
        
        // Disable button and show spinner
        testBtn.disabled = true;
        spinner.classList.remove('d-none');
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
        
        // Collect form data from both forms
        const formData = new FormData();
        
        // Add CSRF token
        formData.append('csrf_token', form.querySelector('input[name="csrf_token"]').value);
        
        // Add test email
        formData.append('test_email', document.getElementById('test_email').value);
        
        // Add SMTP settings from the settings form
        formData.append('smtp_server', document.getElementById('smtp_server').value);
        formData.append('smtp_port', document.getElementById('smtp_port').value);
        formData.append('smtp_use_tls', document.getElementById('smtp_use_tls').checked ? 'on' : '');
        formData.append('smtp_username', document.getElementById('smtp_username').value);
        formData.append('smtp_password', document.getElementById('smtp_password').value);
        formData.append('smtp_from_email', document.getElementById('smtp_from_email').value);
        formData.append('smtp_from_name', document.getElementById('smtp_from_name').value);
        
        // Send test request
        fetch('{{ url_for("core_auth.smtp_test") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable button
            testBtn.disabled = false;
            spinner.classList.add('d-none');
            testBtn.innerHTML = originalText;
            
            // Show toast notification
            if (data.success) {
                showToast('success', 'SMTP Test Successful', data.message);
            } else {
                showToast('danger', 'SMTP Test Failed', data.message);
            }
        })
        .catch(error => {
            // Re-enable button
            testBtn.disabled = false;
            spinner.classList.add('d-none');
            testBtn.innerHTML = originalText;
            
            // Show error toast
            showToast('danger', 'Error', 'An error occurred while testing SMTP: ' + error.message);
        });
    });
</script>
{% endblock %}

