{% extends "base.html" %}
{% from "components/sidebar.html" import render_sidebar %}

{% block title %}Create Document - InfoGarden{% endblock %}

{% block content %}
<div class="content-with-sidebar">
    {{ render_sidebar(doc_tree, passwords, contacts, 'doc', None) }}
    <div class="main-content">
        <h1>Create Document</h1>

        <div class="row mt-4">
            <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="doc-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="content_type_select" class="form-label">Document Type *</label>
                        <select class="form-select" id="content_type_select" name="content_type" required>
                            <option value="markdown" selected>Markdown</option>
                            <option value="html">Rich Text</option>
                        </select>
                        <small class="form-text text-muted">Choose the document format. This cannot be changed after creation.</small>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="content" class="form-label mb-0">Content</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="preview-btn" style="display: none;">
                                <span id="preview-btn-text">Preview</span>
                            </button>
                        </div>
                        <div id="markdown-editor-container">
                            <textarea class="form-control" id="content" name="content" rows="20"></textarea>
                        </div>
                        <div id="richtext-editor-container" style="display: none;">
                            <div id="richtext-editor" style="min-height: 400px;"></div>
                            <textarea id="richtext-content" name="content" style="display: none;"></textarea>
                        </div>
                        <div id="preview-container" style="display: none; margin-top: 1rem;">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Preview</h6>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="close-preview-btn">Close</button>
                                </div>
                                <div class="card-body" id="preview-content" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create</button>
                    <a href="{{ url_for('docs.index') }}" class="btn btn-secondary">Cancel</a>
                </form>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill.js for rich text editing -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    let easyMDE = null;
    let quill = null;
    let currentEditorType = 'markdown';
    
    // Helper function to upload image
    function uploadImageToServer(file, callback) {
        const formData = new FormData();
        formData.append('image', file);
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            formData.append('csrf_token', csrfToken.value);
        }
        
        fetch('{{ url_for("docs.upload_image") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Upload failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.url && callback) {
                callback(data.url);
            }
        })
        .catch(error => {
            alert('Image upload failed: ' + error.message);
            if (callback) callback(null);
        });
    }
    
    // Initialize Quill rich text editor
    function initQuill() {
        quill = new Quill('#richtext-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link', 'image'],
                    ['code-block', 'blockquote'],
                    ['clean']
                ]
            }
        });
        
        // Handle clipboard paste for images
        const editorElement = document.querySelector('#richtext-editor');
        editorElement.addEventListener('paste', function(e) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        uploadImageToServer(file, function(url) {
                            if (url) {
                                const range = quill.getSelection();
                                quill.insertEmbed(range.index, 'image', url);
                            }
                        });
                    }
                    return;
                }
            }
        });
        
        // Handle image upload in Quill toolbar
        const toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/png, image/jpeg, image/gif, image/webp');
            input.click();
            
            input.onchange = function() {
                const file = input.files[0];
                if (!file) return;
                uploadImageToServer(file, function(url) {
                    if (url) {
                        const range = quill.getSelection();
                        quill.insertEmbed(range.index, 'image', url);
                    }
                });
            };
        });
    }
    
    // Wait for EasyMDE to load
    function initEasyMDE() {
        if (typeof EasyMDE !== 'undefined') {
            easyMDE = new EasyMDE({
                element: document.getElementById('content'),
                spellChecker: false,
                uploadImage: true,
                imageUploadEndpoint: '{{ url_for("docs.upload_image") }}',
                previewClass: ['editor-preview', 'markdown-body'],
                imageTexts: {
                    sbInit: 'Drag and drop an image here, or click to select',
                    sbOnDragEnter: 'Drop the image here',
                    sbOnDrop: 'Uploading...',
                    sbProgress: 'Uploading {#imageName#}... {#imageProgress#}%',
                    sbOnUploaded: 'Image uploaded successfully'
                },
                imageUploadFunction: function(file, onSuccess, onError) {
                    uploadImageToServer(file, function(url) {
                        if (url) {
                            onSuccess(url);
                        } else {
                            onError('Upload failed');
                        }
                    });
                },
                // Enable clipboard paste for images
                renderingConfig: {
                    singleLineBreaks: false,
                    codeSyntaxHighlighting: true
                },
                toolbar: [
                    'bold', 'italic', 'strikethrough', '|',
                    'heading-1', 'heading-2', 'heading-3', '|',
                    'code', 'quote', 'unordered-list', 'ordered-list', '|',
                    'link', 'image', 'table', '|',
                    'preview', 'side-by-side', 'fullscreen', '|',
                    'guide'
                ]
            });
            
            // Handle clipboard paste for images in EasyMDE
            easyMDE.codemirror.on('paste', function(editor, event) {
                const items = event.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        event.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            uploadImageToServer(file, function(url) {
                                if (url) {
                                    const cursor = editor.getCursor();
                                    const markdownImage = `![${file.name}](${url})`;
                                    editor.replaceRange(markdownImage, cursor);
                                }
                            });
                        }
                        return;
                    }
                }
            });
            
            // Enable image resize functionality
            function setupImageResize() {
                const previewContainer = document.querySelector('.editor-preview, .editor-preview-side');
                if (!previewContainer) return;
                
                // Remove existing listeners
                previewContainer.querySelectorAll('img').forEach(img => {
                    img.style.cursor = 'pointer';
                    img.title = 'Click to resize image';
                    img.onclick = null; // Remove old handlers
                    img.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openImageResizeDialog(img, easyMDE);
                    });
                });
            }
            
            // Setup image resize when preview updates
            easyMDE.codemirror.on('update', function() {
                setTimeout(setupImageResize, 100);
            });
            
            // Also setup on preview toggle
            const originalPreview = easyMDE.togglePreview;
            easyMDE.togglePreview = function() {
                originalPreview.call(this);
                setTimeout(setupImageResize, 100);
            };
            
            const originalSideBySide = easyMDE.toggleSideBySide;
            easyMDE.toggleSideBySide = function() {
                originalSideBySide.call(this);
                setTimeout(setupImageResize, 100);
            };
            
            // Initial setup
            setTimeout(setupImageResize, 500);
        } else {
            setTimeout(initEasyMDE, 100);
        }
    }
    
    // Handle document type selection (commit to format)
    const contentTypeSelect = document.getElementById('content_type_select');
    contentTypeSelect.addEventListener('change', function() {
        const contentType = this.value;
        const markdownContainer = document.getElementById('markdown-editor-container');
        const richtextContainer = document.getElementById('richtext-editor-container');
        const previewBtn = document.getElementById('preview-btn');
        
        if (contentType === 'markdown') {
            markdownContainer.style.display = 'block';
            richtextContainer.style.display = 'none';
            previewBtn.style.display = 'none';
            currentEditorType = 'markdown';
            if (!easyMDE) {
                initEasyMDE();
            }
        } else {
            markdownContainer.style.display = 'none';
            richtextContainer.style.display = 'block';
            previewBtn.style.display = 'block';
            currentEditorType = 'html';
            if (!quill) {
                initQuill();
            }
        }
    });
    
    // Initialize based on default selection
    if (contentTypeSelect.value === 'markdown') {
        initEasyMDE();
    } else {
        initQuill();
        document.getElementById('preview-btn').style.display = 'block';
    }
    
    // Preview button handler for rich text
    document.getElementById('preview-btn').addEventListener('click', function() {
        const previewContainer = document.getElementById('preview-container');
        const previewContent = document.getElementById('preview-content');
        const previewBtnText = document.getElementById('preview-btn-text');
        
        if (previewContainer.style.display === 'none') {
            // Show preview
            if (currentEditorType === 'html' && quill) {
                previewContent.innerHTML = quill.root.innerHTML;
            } else if (currentEditorType === 'markdown' && easyMDE) {
                // For markdown, use EasyMDE's built-in preview
                easyMDE.togglePreview();
                return;
            }
            previewContainer.style.display = 'block';
            previewBtnText.textContent = 'Hide Preview';
        } else {
            // Hide preview
            previewContainer.style.display = 'none';
            previewBtnText.textContent = 'Preview';
        }
    });
    
    document.getElementById('close-preview-btn').addEventListener('click', function() {
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('preview-btn-text').textContent = 'Preview';
    });
    
    // Handle form submission - sync content
    document.getElementById('doc-form').addEventListener('submit', function(e) {
        const contentType = contentTypeSelect.value;
        
        if (contentType === 'html' && quill) {
            // Get HTML from Quill and put it in hidden textarea
            const htmlContent = quill.root.innerHTML;
            document.getElementById('richtext-content').value = htmlContent;
            // Also update the main content field
            document.getElementById('content').value = htmlContent;
        } else if (contentType === 'markdown' && easyMDE) {
            // Get markdown from EasyMDE
            const markdownContent = easyMDE.value();
            document.getElementById('content').value = markdownContent;
        }
    });
    
    // Image resize dialog function
    function openImageResizeDialog(imgElement, easyMDE) {
        const src = imgElement.src;
        const currentWidth = imgElement.width || imgElement.naturalWidth;
        const currentHeight = imgElement.height || imgElement.naturalHeight;
        const naturalWidth = imgElement.naturalWidth;
        const naturalHeight = imgElement.naturalHeight;
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Resize Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3 text-center">
                            <img id="resize-preview-img" src="${src}" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="resize-width" class="form-label">Width</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="resize-width" value="${currentWidth}" min="1">
                                    <select class="form-select" id="resize-width-unit" style="max-width: 80px;">
                                        <option value="px">px</option>
                                        <option value="%">%</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="resize-height" class="form-label">Height</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="resize-height" value="${currentHeight}" min="1">
                                    <select class="form-select" id="resize-height-unit" style="max-width: 80px;">
                                        <option value="px">px</option>
                                        <option value="%">%</option>
                                        <option value="auto">auto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="resize-maintain-aspect" checked>
                                <label class="form-check-label" for="resize-maintain-aspect">
                                    Maintain aspect ratio
                                </label>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Original size: ${naturalWidth} Ã— ${naturalHeight}px</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="resize-apply-btn">Apply</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        const widthInput = modal.querySelector('#resize-width');
        const heightInput = modal.querySelector('#resize-height');
        const widthUnit = modal.querySelector('#resize-width-unit');
        const heightUnit = modal.querySelector('#resize-height-unit');
        const maintainAspect = modal.querySelector('#resize-maintain-aspect');
        const previewImg = modal.querySelector('#resize-preview-img');
        const applyBtn = modal.querySelector('#resize-apply-btn');
        
        // Update preview on input change
        function updatePreview() {
            const width = widthInput.value;
            const widthUnitVal = widthUnit.value;
            const height = heightInput.value;
            const heightUnitVal = heightUnit.value;
            
            if (widthUnitVal === 'px') {
                previewImg.style.width = width + 'px';
            } else {
                previewImg.style.width = width + '%';
            }
            
            if (heightUnitVal === 'auto') {
                previewImg.style.height = 'auto';
            } else if (heightUnitVal === 'px') {
                previewImg.style.height = height + 'px';
            } else {
                previewImg.style.height = height + '%';
            }
        }
        
        // Maintain aspect ratio
        let lastChanged = 'width';
        widthInput.addEventListener('input', function() {
            if (maintainAspect.checked && widthUnit.value === 'px' && heightUnit.value === 'px') {
                const ratio = naturalHeight / naturalWidth;
                heightInput.value = Math.round(widthInput.value * ratio);
            }
            lastChanged = 'width';
            updatePreview();
        });
        
        heightInput.addEventListener('input', function() {
            if (maintainAspect.checked && widthUnit.value === 'px' && heightUnit.value === 'px') {
                const ratio = naturalWidth / naturalHeight;
                widthInput.value = Math.round(heightInput.value * ratio);
            }
            lastChanged = 'height';
            updatePreview();
        });
        
        widthUnit.addEventListener('change', updatePreview);
        heightUnit.addEventListener('change', updatePreview);
        maintainAspect.addEventListener('change', function() {
            if (this.checked && widthUnit.value === 'px' && heightUnit.value === 'px') {
                const ratio = naturalHeight / naturalWidth;
                heightInput.value = Math.round(widthInput.value * ratio);
            }
            updatePreview();
        });
        
        // Apply resize
        applyBtn.addEventListener('click', function() {
            const width = widthInput.value;
            const widthUnitVal = widthUnit.value;
            const height = heightInput.value;
            const heightUnitVal = heightUnit.value;
            
            // Build the HTML img tag with attributes
            let imgTag = '<img src="' + src + '"';
            let styleParts = [];
            let hasWidthAttr = false;
            let hasHeightAttr = false;
            
            // Handle width
            if (widthUnitVal === 'px') {
                imgTag += ' width="' + width + '"';
                hasWidthAttr = true;
            } else {
                styleParts.push('width: ' + width + '%');
            }
            
            // Handle height
            if (heightUnitVal === 'px') {
                imgTag += ' height="' + height + '"';
                hasHeightAttr = true;
            } else if (heightUnitVal === '%') {
                styleParts.push('height: ' + height + '%');
            } else if (heightUnitVal === 'auto') {
                styleParts.push('height: auto');
            }
            
            // Add style attribute if needed
            if (styleParts.length > 0) {
                imgTag += ' style="' + styleParts.join('; ') + '"';
            }
            
            imgTag += '>';
            
            // Find and replace the image in markdown
            const content = easyMDE.value();
            const lines = content.split('\n');
            
            // Extract filename from src
            const srcFilename = src.split('/').pop();
            const srcPath = src;
            
            // Find the line with the image
            let found = false;
            for (let i = 0; i < lines.length; i++) {
                // Check for markdown image syntax ![alt](url)
                const mdImageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
                let match;
                while ((match = mdImageRegex.exec(lines[i])) !== null) {
                    const url = match[2];
                    // Match by filename or full path
                    if (url.includes(srcFilename) || url === srcPath || srcPath.includes(url)) {
                        lines[i] = lines[i].replace(match[0], imgTag);
                        found = true;
                        break;
                    }
                }
                if (found) break;
                
                // Check for HTML img tag
                const htmlImgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
                while ((match = htmlImgRegex.exec(lines[i])) !== null) {
                    const url = match[1];
                    // Match by filename or full path
                    if (url.includes(srcFilename) || url === srcPath || srcPath.includes(url)) {
                        lines[i] = lines[i].replace(match[0], imgTag);
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            
            if (found) {
                easyMDE.value(lines.join('\n'));
                bsModal.hide();
                setTimeout(() => {
                    document.body.removeChild(modal);
                    setupImageResize();
                }, 300);
            } else {
                alert('Could not find image in markdown. Please update manually.');
            }
        });
        
        // Clean up on close
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
        
        updatePreview();
    }
</script>
<style>
    /* EasyMDE preview styling for images */
    .editor-preview img,
    .editor-preview-side img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1rem auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: opacity 0.2s;
    }
    .editor-preview img:hover,
    .editor-preview-side img:hover {
        opacity: 0.8;
        border-color: #007bff;
    }
    .editor-preview .youtube-embed,
    .editor-preview-side .youtube-embed {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        margin: 1rem 0;
    }
    .editor-preview .youtube-embed iframe,
    .editor-preview-side .youtube-embed iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    /* Preview container styling */
    #preview-content {
        line-height: 1.6;
    }
    #preview-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1rem auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #preview-content h1, #preview-content h2, #preview-content h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    #preview-content p {
        margin-bottom: 1rem;
    }
    #preview-content ul, #preview-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }
    #preview-content blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #666;
    }
    #preview-content code {
        background-color: #f4f4f4;
        padding: 2px 5px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }
    #preview-content pre {
        background-color: #f4f4f4;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        margin: 1rem 0;
    }
</style>
{% endblock %}

